name: Deploy to Raspberry Pi

on:
  push:
    branches: [ main ]
  # Remove pull_request if you only want to deploy on main branch pushes
  workflow_dispatch:  # Allows manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Deploy to Raspberry Pi
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.PI_HOST }}
        username: ${{ secrets.PI_USERNAME }}
        key: ${{ secrets.PI_SSH_KEY }}
        port: 22
        script: |
          echo "ðŸš€ Starting deployment..."
          
          # Create app directory if it doesn't exist
          mkdir -p ~/apps/plobet-app
          cd ~/apps/plobet-app
          
          # Clone or pull latest code
          if [ -d ".git" ]; then
            echo "ðŸ“¥ Pulling latest changes..."
            git pull origin main
          else
            echo "ðŸ“¥ Cloning repository..."
            git clone https://github.com/${{ github.repository }}.git .
          fi
          
          # Stop and remove existing container
          echo "ðŸ›‘ Stopping existing container..."
          docker stop plobet-app 2>/dev/null || echo "No container to stop"
          docker rm plobet-app 2>/dev/null || echo "No container to remove"
          
          # Build new image
          echo "ðŸ”¨ Building Docker image..."
          docker build -t plobet-app:latest .
          
          # Remove old images to save space
          echo "ðŸ§¹ Cleaning up old images..."
          docker image prune -f
          
          # Run new container
          echo "ðŸš€ Starting new container..."
          docker run -d \
            --name plobet-app \
            --restart unless-stopped \
            -p 3000:3000 \
            -e NODE_ENV=production \
            -e NEXT_TELEMETRY_DISABLED=1 \
            plobet-app:latest
          
          # Show deployment status
          echo "âœ… Deployment complete!"
          echo "Container status:"
          docker ps --filter name=plobet-app --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          
          # Show logs (last 10 lines)
          echo "ðŸ“‹ Recent logs:"
          docker logs --tail 10 plobet-app